import{r as m,b as k,j as e,d as f,c as M,h as L,f as O}from"./index-b9d71b5a.js";import{A as E}from"./index.esm-67bcb648.js";import{G as V}from"./iconBase-290ccf58.js";import{b as R,e as D,i as H}from"./utils-5b6e37df.js";import{b,c as v,d as w,e as y,D as g,a as C}from"./dialog-3a7efce3.js";import{B as u}from"./index-6f6767bb.js";import{u as S}from"./useDispatch-8fbe3b0f.js";import{I as N}from"./input-2864de84.js";import{d as U}from"./index.esm-2f00b71c.js";import{a as P,b as T,c as A}from"./index.esm-73338d56.js";import{R as G}from"./ReadmeBtn-67aaebdf.js";import"./jszip.min-58022e77.js";function z(a){return V({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"m12 18 4-5h-3V2h-2v11H8z"}},{tag:"path",attr:{d:"M19 9h-4v2h4v9H5v-9h4V9H5c-1.103 0-2 .897-2 2v9c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-9c0-1.103-.897-2-2-2z"}}]})(a)}function J({setModalOpen:a,afterSave:o}){const[l,i]=m.useState("-1"),{mymaps:r,defaultMap:t}=k(s=>s.maps),d=S(),p=()=>{const s=t.data?t:JSON.parse(localStorage.getItem("tempNewMap")),c=R(s),n=JSON.parse(localStorage.getItem("tempLayer"));if(l==="-1")c.data=[...c.data,...n];else{const h=c.data.findIndex(x=>x.id===l);c.data[h].markers=[...c.data[h].markers,...n[0].markers]}if(r.length===0)d(f([c]));else{const h=r.map(x=>x.id===t.id?c:x);d(f(h))}d(M(c)),localStorage.removeItem("tempLayer"),localStorage.removeItem("tempNewMap"),a(!1),o&&o(l)};return e.jsx(e.Fragment,{children:e.jsxs(b,{className:"modalContent",children:[e.jsx(v,{children:e.jsx(w,{children:"匯入 / 新建圖層"})}),e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:"選擇匯入圖層"}),e.jsxs("select",{className:"w-full h-10 border border-gray-300 rounded-md px-2",value:l,onChange:s=>i(s.target.value),children:[e.jsx("option",{value:"-1",children:"建立新圖層"}),t.data&&t.data.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx(y,{children:e.jsx(u,{type:"submit",onClick:p,children:"確定"})})]})})}function q({afterSave:a,setModalOpen:o}){const[l,i]=m.useState(""),r=()=>{const t={id:Date.now(),name:l,data:[]};localStorage.setItem("tempNewMap",JSON.stringify(t)),o(!1),a&&a()};return e.jsx(e.Fragment,{children:e.jsxs(b,{className:"modalContent",children:[e.jsx(v,{children:e.jsx(w,{children:"設定地圖名稱"})}),e.jsx(e.Fragment,{children:e.jsx(N,{type:"text",defaultValue:l,onChange:t=>i(t.target.value)})}),e.jsx(y,{children:e.jsx(u,{type:"submit",onClick:r,children:"建立新地圖"})})]})})}function _({afterSave:a,setModalOpen:o}){const[l,i]=L(),[r,t]=m.useState(l.get("mid")||""),[d,p]=m.useState(l.get("name")||""),s=m.useRef(),c=()=>{if(r===""){alert("請輸入我的地圖網址");return}else if((!r.includes("mid=")||!r.includes("google.com/maps/"))&&r.includes("https://")){t(""),alert("無法正確解析網址，請確認網址是否正確");return}const n=r.indexOf("mid=")>0?r.indexOf("mid=")+4:0,h=r.indexOf("&",n)>0?r.indexOf("&",n):r.length,x=r.substring(n,h);o(!1),a(x,d),i({})};return e.jsx(e.Fragment,{children:e.jsxs(b,{className:"modalContent",children:[e.jsx(v,{children:e.jsx(w,{children:"匯入地圖"})}),e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"text-blue-500",href:"https://gg90052.github.io/blog/goom/",target:"_blank",rel:"noreferrer",children:"如何取得我的地圖網址？"}),e.jsx(N,{type:"text",placeholder:"請輸入地圖 Mid 或我的地圖網址",defaultValue:r,onChange:n=>t(n.target.value)}),e.jsx(N,{type:"text",placeholder:"請輸入地圖名稱(選填)",ref:s,defaultValue:d,onChange:n=>p(n.target.value)})]}),e.jsx(y,{children:e.jsx(u,{type:"submit",onClick:c,children:"匯入地圖"})})]})})}const B=m.forwardRef(({type:a="import",size:o=24},l)=>{const[i,r]=m.useState(!1),[t,d]=m.useState(!1),[p,s]=m.useState(!1),{mymaps:c}=k(j=>j.maps),n=S(),h=O(),x=async(j,F)=>{const I=await D(j,F);n(M(I)),n(f([...c,I])),h("/")};return e.jsxs("div",{className:a==="full"?"w-full h-full absolute":"",children:[a==="import"&&e.jsx(z,{size:o,ref:l,onClick:()=>r(!0)}),a==="full"&&e.jsx("div",{className:"w-full h-full",ref:l,onClick:()=>r(!0)}),e.jsx(g,{open:i,onOpenChange:r,children:e.jsx(_,{afterSave:(j,F)=>x(j,F),setModalOpen:r})}),e.jsx(g,{open:t,onOpenChange:d,children:e.jsx(q,{afterSave:()=>s(!0),setModalOpen:d})}),e.jsx(g,{open:p,onOpenChange:s,children:e.jsx(J,{setModalOpen:s})})]})});B.displayName="MapUploader";function K({map:a}){const[o,l]=m.useState(""),{mymaps:i,defaultMap:r}=k(s=>s.maps),t=S(),d=()=>{const s=R(a);s.name=o;const c=i.map(n=>n.id===a.id?s:n);t(f(c))},p=()=>{const s=i.filter(c=>c.id!==a.id);t(f(s)),r.id===a.id&&t(M(s.length>0?s[0]:{}))};return e.jsxs(g,{children:[e.jsx(C,{asChild:!0,children:e.jsx(u,{className:"w-full rounded-none bg-slate-600 text-white",children:"編輯"})}),e.jsxs(b,{className:"modalContent",children:[e.jsx(v,{children:e.jsx(w,{children:"編輯地圖"})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:"地圖名稱"}),e.jsx(N,{id:"mapName",defaultValue:a.name,onChange:s=>l(s.target.value),className:"w-full"})]}),e.jsxs(y,{className:"w-full flex flex-row flex-nowrap items-center",children:[e.jsx(C,{asChild:!0,children:e.jsx(u,{className:"w-[90px] shrink-0 mr-8 text-red-700 hover:text-red-500",variant:"ghost",size:"sm",onClick:p,children:"刪除地圖"})}),e.jsx(C,{asChild:!0,children:e.jsx(u,{className:"grow shrink-0",type:"submit",onClick:d,children:"儲存"})})]})]})]})}function Q({map:a}){const o=window.location.href+"?mid="+a.mid+"&name="+a.name,l=a.mid;async function i(t){try{await navigator.clipboard.writeText(t),alert(`已複製Mid：
`+t)}catch(d){console.error(d)}}const r=()=>{navigator.share?navigator.share({title:document.title,text:"地圖分享 - "+a.name,url:o}).then(()=>console.log("成功！")).catch(t=>console.log("發生錯誤",t)):console.log(o)};return e.jsx(e.Fragment,{children:e.jsxs(b,{className:"modalContent",children:[e.jsx(v,{children:e.jsx(w,{children:"分享地圖"})}),e.jsxs(e.Fragment,{children:[e.jsxs("h1",{className:"text-lg text-center",children:[e.jsx(U,{size:24,className:"inline-block mr-2",color:"#5bb531"}),a.name]}),e.jsxs("div",{className:"row",children:[e.jsx("label",{className:"w-full block mb-2",htmlFor:"shareMid",children:"地圖 Mid："}),e.jsxs("div",{className:"inputGroup",children:[e.jsx(N,{className:"grow",name:"shareMid",type:"text",value:l,readOnly:!0}),e.jsx("div",{className:"shrink-0 ml-2 bg-slate-100 p-2 border border-slate-400",onClick:()=>i(a.mid),children:e.jsx(P,{size:"20",color:"#666"})})]})]})]}),e.jsx(y,{children:e.jsx(u,{type:"submit",onClick:r,children:"分享"})})]})})}function W({map:a}){return e.jsxs(g,{children:[e.jsx(C,{asChild:!0,children:e.jsxs(u,{className:"w-full rounded-none bg-green-600 text-white",children:[e.jsx(T,{className:"mr-2"}),"分享"]})}),e.jsx(Q,{map:a})]})}function X({item:a,afterSyncMap:o}){const[l,i]=m.useState(a),[r,t]=m.useState(!1),d=O(),p=S(),s=n=>{localStorage.showedLayer="",p(M(n)),d("/")},c=async()=>{t(!0);const n=await D(a.mid,a.name,a.id);i(n),o(n),t(!1)};return e.jsxs("div",{className:"border border-gray-300 cursor-pointer flex flex-col justify-between relative",children:[r&&e.jsx("div",{className:"z-10 absolute w-full h-full flex justify-center items-center bg-black/70 text-white",children:"同步地圖中..."}),a.mid&&e.jsx("div",{className:"absolute top-0 right-0 p-3",children:e.jsx(A,{size:24,color:"#5bb531",onClick:c})}),e.jsxs("div",{className:"flex flex-col justify-center items-center my-4 px-4 grow",onClick:()=>s(l),children:[e.jsx(U,{size:44,color:"#5bb531"}),e.jsx("p",{className:"text-center mt-2",children:a.name})]},a.id),e.jsxs("div",{className:"flex",children:[e.jsx(K,{map:a}),a.mid&&e.jsx(W,{map:a})]})]})}function Y(){const[a]=L(),o=m.useRef(),l=a.get("mid");m.useEffect(()=>{l&&o.current.click()},[l,o]);const{mymaps:i}=k(s=>s.maps),r=O(),t=S(),d=s=>{const c=i.map(n=>n.id===s.id?s:n);t(f(c))},p=()=>{const s=H();t(M(s)),t(f([...i,s])),r("/")};return e.jsxs("div",{className:"p-4",children:[i.length===0&&e.jsx(G,{}),e.jsx("button",{className:"w-full h-12 border-dashed border-2 text-gray-500",children:e.jsxs("div",{className:"flex justify-center relative",children:[e.jsx(B,{className:"absolute",type:"full",ref:o}),e.jsx(z,{size:24}),e.jsx("p",{className:"ml-2",children:"匯入地圖"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[i.map(s=>e.jsx(X,{item:s,afterSyncMap:d},s.id)),e.jsxs("div",{onClick:p,className:"p-4 border border-gray-300 flex flex-col justify-center items-center cursor-pointer","data-cy":"add-blank-map",children:[e.jsx(E,{size:44,color:"#999"}),e.jsx("p",{className:"text-center mt-2 text-[#999]",children:"新增空白地圖"})]})]})]})}function de(){return e.jsx("div",{className:"w-full h-full",children:e.jsx(Y,{})})}export{de as default};
