import{r as m,b,j as e,d as f,c as j,h as L,f as O}from"./index-82b4b9af.js";import{A as B}from"./index.esm-f971dff8.js";import{G as E}from"./iconBase-5c5403bf.js";import{b as R,e as D,i as V}from"./utils-5d665634.js";import{b as w,c as y,d as S,e as C,D as M,a as I}from"./dialog-16fa05af.js";import{B as x}from"./index-6a2584a5.js";import{u as N}from"./useDispatch-dedc725b.js";import{I as v}from"./input-5b8f24c4.js";import{d as H}from"./index.esm-38edd811.js";import{a as P,b as A}from"./index.esm-ca1a20d0.js";import{R as J}from"./ReadmeBtn-00ea4169.js";import"./jszip.min-c6f4c7f2.js";function U(t){return E({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{d:"m12 18 4-5h-3V2h-2v11H8z"}},{tag:"path",attr:{d:"M19 9h-4v2h4v9H5v-9h4V9H5c-1.103 0-2 .897-2 2v9c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-9c0-1.103-.897-2-2-2z"}}]})(t)}function G({setModalOpen:t,afterSave:c}){const[l,i]=m.useState("-1"),{mymaps:s,defaultMap:n}=b(a=>a.maps),d=N(),p=()=>{const a=n.data?n:JSON.parse(localStorage.getItem("tempNewMap")),o=R(a),r=JSON.parse(localStorage.getItem("tempLayer"));if(l==="-1")o.data=[...o.data,...r];else{const u=o.data.findIndex(h=>h.id===l);o.data[u].markers=[...o.data[u].markers,...r[0].markers]}if(s.length===0)d(f([o]));else{const u=s.map(h=>h.id===n.id?o:h);d(f(u))}d(j(o)),localStorage.removeItem("tempLayer"),localStorage.removeItem("tempNewMap"),t(!1),c&&c(l)};return e.jsx(e.Fragment,{children:e.jsxs(w,{className:"modalContent",children:[e.jsx(y,{children:e.jsx(S,{children:"匯入 / 新建圖層"})}),e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:"選擇匯入圖層"}),e.jsxs("select",{className:"w-full h-10 border border-gray-300 rounded-md px-2",value:l,onChange:a=>i(a.target.value),children:[e.jsx("option",{value:"-1",children:"建立新圖層"}),n.data&&n.data.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsx(C,{children:e.jsx(x,{type:"submit",onClick:p,children:"確定"})})]})})}function T({afterSave:t,setModalOpen:c}){const[l,i]=m.useState(""),s=()=>{const n={id:Date.now(),name:l,data:[]};localStorage.setItem("tempNewMap",JSON.stringify(n)),c(!1),t&&t()};return e.jsx(e.Fragment,{children:e.jsxs(w,{className:"modalContent",children:[e.jsx(y,{children:e.jsx(S,{children:"設定地圖名稱"})}),e.jsx(e.Fragment,{children:e.jsx(v,{type:"text",defaultValue:l,onChange:n=>i(n.target.value)})}),e.jsx(C,{children:e.jsx(x,{type:"submit",onClick:s,children:"建立新地圖"})})]})})}function q({afterSave:t,setModalOpen:c}){const[l,i]=L(),[s,n]=m.useState(l.get("mid")||""),[d,p]=m.useState(l.get("name")||""),a=m.useRef(),o=()=>{if(s===""){alert("請輸入我的地圖網址");return}else if((!s.includes("mid=")||!s.includes("google.com/maps/"))&&s.includes("https://")){n(""),alert("無法正確解析網址，請確認網址是否正確");return}const r=s.indexOf("mid=")>0?s.indexOf("mid=")+4:0,u=s.indexOf("&",r)>0?s.indexOf("&",r):s.length,h=s.substring(r,u);c(!1),t(h,d),i({})};return e.jsx(e.Fragment,{children:e.jsxs(w,{className:"modalContent",children:[e.jsx(y,{children:e.jsx(S,{children:"從我的地圖網址匯入..."})}),e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"text-blue-500",href:"https://gg90052.github.io/blog/goom/",target:"_blank",rel:"noreferrer",children:"如何取得我的地圖網址？"}),e.jsx(v,{type:"text",placeholder:"請輸入我的地圖網址",defaultValue:s,onChange:r=>n(r.target.value)}),e.jsx(v,{type:"text",placeholder:"請輸入地圖名稱(選填)",ref:a,defaultValue:d,onChange:r=>p(r.target.value)})]}),e.jsx(C,{children:e.jsx(x,{type:"submit",onClick:o,children:"匯入地圖"})})]})})}const z=m.forwardRef(({type:t="import",size:c=24},l)=>{const[i,s]=m.useState(!1),[n,d]=m.useState(!1),[p,a]=m.useState(!1),{mymaps:o}=b(g=>g.maps),r=N(),u=O(),h=async(g,k)=>{const F=await D(g,k);r(j(F)),r(f([...o,F])),u("/")};return e.jsxs("div",{className:t==="full"?"w-full h-full absolute":"",children:[t==="import"&&e.jsx(U,{size:c,ref:l,onClick:()=>s(!0)}),t==="full"&&e.jsx("div",{className:"w-full h-full",ref:l,onClick:()=>s(!0)}),e.jsx(M,{open:i,onOpenChange:s,children:e.jsx(q,{afterSave:(g,k)=>h(g,k),setModalOpen:s})}),e.jsx(M,{open:n,onOpenChange:d,children:e.jsx(T,{afterSave:()=>a(!0),setModalOpen:d})}),e.jsx(M,{open:p,onOpenChange:a,children:e.jsx(G,{setModalOpen:a})})]})});z.displayName="MapUploader";function _({map:t}){const[c,l]=m.useState(""),{mymaps:i,defaultMap:s}=b(a=>a.maps),n=N(),d=()=>{const a=R(t);a.name=c;const o=i.map(r=>r.id===t.id?a:r);n(f(o))},p=()=>{const a=i.filter(o=>o.id!==t.id);n(f(a)),s.id===t.id&&n(j(a.length>0?a[0]:{}))};return e.jsxs(M,{children:[e.jsx(I,{asChild:!0,children:e.jsx(x,{className:"w-full rounded-none bg-slate-600 text-white",children:"編輯"})}),e.jsxs(w,{className:"modalContent",children:[e.jsx(y,{children:e.jsx(S,{children:"編輯地圖"})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:"地圖名稱"}),e.jsx(v,{id:"mapName",defaultValue:t.name,onChange:a=>l(a.target.value),className:"w-full"})]}),e.jsxs(C,{className:"w-full flex flex-row flex-nowrap items-center",children:[e.jsx(I,{asChild:!0,children:e.jsx(x,{className:"w-[90px] shrink-0 mr-8 text-red-700 hover:text-red-500",variant:"ghost",size:"sm",onClick:p,children:"刪除地圖"})}),e.jsx(I,{asChild:!0,children:e.jsx(x,{className:"grow shrink-0",type:"submit",onClick:d,children:"儲存"})})]})]})]})}function K({map:t}){const c=()=>{navigator.share?navigator.share({title:document.title,text:"地圖分享 - "+t.name,url:window.location.href+"?mid="+t.mid+"&name="+t.name}).then(()=>console.log("成功！")).catch(l=>console.log("發生錯誤",l)):console.log("https://gg90052.github.io/goom/#/mapSelect?mid="+t.mid+"&name="+t.name)};return e.jsxs(x,{onClick:c,className:"w-full rounded-none bg-green-600 text-white",children:[e.jsx(P,{className:"mr-2"}),"分享"]})}function Q({item:t,afterSyncMap:c}){const[l,i]=m.useState(t),[s,n]=m.useState(!1),d=O(),p=N(),a=r=>{localStorage.showedLayer="",p(j(r)),d("/")},o=async()=>{n(!0);const r=await D(t.mid,t.name,t.id);i(r),c(r),n(!1)};return e.jsxs("div",{className:"border border-gray-300 cursor-pointer flex flex-col justify-between relative",children:[s&&e.jsx("div",{className:"z-10 absolute w-full h-full flex justify-center items-center bg-black/70 text-white",children:"同步地圖中..."}),t.mid&&e.jsx("div",{className:"absolute top-0 right-0 p-3",children:e.jsx(A,{size:24,color:"#5bb531",onClick:o})}),e.jsxs("div",{className:"flex flex-col justify-center items-center my-4 px-4 grow",onClick:()=>a(l),children:[e.jsx(H,{size:44,color:"#5bb531"}),e.jsx("p",{className:"text-center mt-2",children:t.name})]},t.id),e.jsxs("div",{className:"flex",children:[e.jsx(_,{map:t}),t.mid&&e.jsx(K,{map:t})]})]})}function W(){const[t]=L(),c=m.useRef(),l=t.get("mid");m.useEffect(()=>{l&&c.current.click()},[l,c]);const{mymaps:i}=b(a=>a.maps),s=O(),n=N(),d=a=>{const o=i.map(r=>r.id===a.id?a:r);n(f(o))},p=()=>{const a=V();n(j(a)),n(f([...i,a])),s("/")};return e.jsxs("div",{className:"p-4",children:[i.length===0&&e.jsx(J,{}),e.jsx("button",{className:"w-full h-12 border-dashed border-2 text-gray-500",children:e.jsxs("div",{className:"flex justify-center relative",children:[e.jsx(z,{className:"absolute",type:"full",ref:c}),e.jsx(U,{size:24}),e.jsx("p",{className:"ml-2",children:"匯入地圖"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[i.map(a=>e.jsx(Q,{item:a,afterSyncMap:d},a.id)),e.jsxs("div",{onClick:p,className:"p-4 border border-gray-300 flex flex-col justify-center items-center cursor-pointer","data-cy":"add-blank-map",children:[e.jsx(B,{size:44,color:"#999"}),e.jsx("p",{className:"text-center mt-2 text-[#999]",children:"新增空白地圖"})]})]})]})}function ce(){return e.jsx("div",{className:"w-full h-full",children:e.jsx(W,{})})}export{ce as default};
