import{b as v,r as h,j as e,d as T,c as L,e as O,f as A,g as E,h as B,_ as F,N as P,A as S}from"./index-b32ba2ff.js";import{D as U,a as b,b as H,c as V,d as $,e as q,M as J,B as G,R as K,s as Q}from"./ReadmeBtn-422dd024.js";import{F as W,M as X}from"./MarkerItem-01f610e4.js";import{b as Y,c as Z,d as ee,e as ae}from"./index.esm-1b05e88d.js";import{u as C}from"./useLocalStorageState-f2535dd3.js";import{B as _}from"./supabaseClient-931ecde0.js";import{b as se,c as te,e as re,f as ne}from"./utils-cd62d901.js";import{a as ie}from"./index.esm-7f943a18.js";import{M as de}from"./index.esm-12467b6b.js";import{u as N}from"./iconBase-76246718.js";import{u as D}from"./useDispatch-f95a81f6.js";import"./index.esm-e4c9e803.js";import"./index.esm-cf61964d.js";import"./Icon-7aff4480.js";function oe({layerId:d,name:x,children:f,onEdit:c}){var n;const{isEditMode:g,mymaps:i,showMapID:s}=v(l=>l.maps),w=i.find(l=>l.id===s),[o,y]=C([],"showedLayer"),[m,t]=h.useState(o.includes(d)),p=((n=w.data.find(l=>l.id===d))==null?void 0:n.markers.length)||0,M=l=>{t(a=>!a);const u=JSON.parse(localStorage.getItem("showedLayer"));u.includes(d)?y(u.filter(a=>a!==d)):y([...u,d])};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"markerLayer","data-cy":"layer-comp",children:[m===!0?e.jsx(Y,{size:24,fill:"#73D0FA"}):e.jsx(Z,{size:24,fill:"#73D0FA"}),e.jsx("p",{className:"grow",onClick:M,children:`${x} (${p})`}),e.jsx("div",{className:g?"w-6 h-6":"hidden",children:e.jsx("div",{className:"w-6 h-6",children:e.jsx(W,{size:24,"data-cy":"triggerEditLayerModal",className:g?"slideIn":"slideOutRight",onClick:c})})})]}),m===!0&&e.jsx("ul",{children:f})]})}function le({className:d}){const{t:x}=N(),{selectedMarkerItem:f,mymaps:c,showMapID:g}=v(t=>t.maps),i=c.find(t=>t.id===g),[s,w]=h.useState(i.data?i.data[0].id:"-1"),o=D(),y=()=>{const t=m();o(T([])),o(L(t))},m=()=>{let t=[];const p=i.data.map(n=>{const l=n.markers.filter(u=>{const a=f.includes(u.id);return a&&t.push(u),!a});return{...n,markers:l}}),M=p.findIndex(n=>n.id===s);if(M>-1){const n=p[M];p[M]={...n,markers:[...n.markers,...t]}}return{...i,data:p}};return e.jsxs(U,{children:[e.jsx(b,{children:e.jsx(de,{size:24,fill:"#F1D272",className:d})}),e.jsxs(H,{className:"modalContent","data-cy":"editLayerModal",children:[e.jsx(V,{children:e.jsxs($,{children:[x("index.moveMarker"),"..."]})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:x("index.selectLayer")}),e.jsx("select",{className:"w-full h-10 border border-gray-300 rounded-md px-2",value:s,onChange:t=>w(t.target.value),children:i.data&&i.data.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsx(q,{className:"w-full flex flex-row flex-nowrap items-center",children:e.jsx(b,{asChild:!0,children:e.jsx(_,{className:"grow shrink-0","data-cy":"saveLayer",type:"submit",onClick:y,children:x("index.move")})})})]})]})}function ce({name:d,addLayer:x=!0,sync:f}){const{t:c}=N(),{mymaps:g,showMapID:i,isEditMode:s,selectedMarkerItem:w}=v(a=>a.maps),o=g.find(a=>a.id===i),y=o.data.some(a=>a.mid),[m,t]=C("-1","defaultLayer"),{pathname:p}=O(),M=A(),n=D();h.useEffect(()=>{n(E(!1))},[p,n]);const l=()=>{if(!s)return;const a=se(o),r=te();a.data=[...a.data,r],n(L(a)),m==="-1"&&t(r.id)},u=()=>{n(B("")),M("/mapSelect")};return e.jsx("header",{className:"h-14 flex px-4 items-center gap-4 justify-between bg-slate-100 fixed top-0 left-0 w-full z-40",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-4 grow",children:[e.jsxs(_,{"data-cy":"map-name",variant:"outline",onClick:u,children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),d]}),y&&e.jsx(ie,{className:s?"hidden":"",size:24,color:"#5bb531",onClick:f,"data-cy":"syncMap"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(le,{className:s&&w.length>0?"fadeIn":"fadeOut hidden"}),e.jsx(ae,{"data-cy":"add-layer",className:s?"fadeIn":"fadeOut",onClick:l,size:24,fill:"#F1D272"}),e.jsx("p",{"data-cy":"trigger-edit-mode",className:"text-blue-500 whitespace-nowrap",onClick:()=>n(E(!s)),children:c(s?"common.finish":"common.edit")})]})]}):e.jsx("p",{children:d})})}const me=h.lazy(()=>F(()=>import("./EditMarkerModal-1fe23476.js"),["assets/EditMarkerModal-1fe23476.js","assets/index-b32ba2ff.js","assets/index-f59ac340.css","assets/supabaseClient-931ecde0.js","assets/ReadmeBtn-422dd024.js","assets/iconBase-76246718.js","assets/utils-cd62d901.js","assets/useDispatch-f95a81f6.js","assets/index.esm-e4c9e803.js"])),pe=h.lazy(()=>F(()=>import("./EditLayerModal-6c2f7508.js"),["assets/EditLayerModal-6c2f7508.js","assets/index-b32ba2ff.js","assets/index-f59ac340.css","assets/supabaseClient-931ecde0.js","assets/ReadmeBtn-422dd024.js","assets/iconBase-76246718.js","assets/utils-cd62d901.js","assets/useDispatch-f95a81f6.js","assets/index.esm-e4c9e803.js","assets/MarkerItem-01f610e4.js","assets/index.esm-7f943a18.js","assets/index.esm-cf61964d.js","assets/index.esm-12467b6b.js","assets/Icon-7aff4480.js","assets/useLocalStorageState-f2535dd3.js"]));function Ie(){var u;const{t:d}=N(),x=D(),{mymaps:f,showMapID:c}=v(a=>a.maps),g=h.useRef(),i=f.find(a=>a.id===c),[s,w]=h.useState(i),[o,y]=h.useState(null),[m,t]=h.useState(null);if(h.useEffect(()=>{w(f.find(a=>a.id===c))},[c,f]),c==="")return e.jsx(P,{to:"/mapSelect"});const p=async()=>{const a=s.data.filter(j=>j.mid),r=[...new Set(a.map(j=>j.mid))];try{const z=(await Promise.all(r.map(k=>M(k)))).flatMap(k=>k.data),R=[...s.data.filter(k=>!k.mid),...z],I={...s,data:R};w(I),x(L(I)),S.success("地圖同步完成")}catch(j){console.error(j),S.error("同步過程發生錯誤")}finally{}},M=async a=>{try{let r;return re(a)?r=(await Q(a)).map:r=await ne(a),r.data.forEach(j=>{j.mid=a}),r}catch(r){console.log(r)}},n=(a,r)=>{y({marker:a,layerId:r})},l=(a,r)=>{t({layerId:r,layerName:a})};return e.jsxs(e.Fragment,{children:[e.jsx(ce,{name:s.name,sync:p}),((u=s==null?void 0:s.data)==null?void 0:u.length)>0?e.jsx(e.Fragment,{children:e.jsxs("div",{style:{height:"100%",overflow:"auto",paddingTop:"3.5rem",paddingBottom:"4.5rem"},children:[s.data&&s.data.map(a=>e.jsx(oe,{name:a.name,layerId:a.id,mapId:s.id,mid:a.mid,syncLayer:p,onEdit:()=>l(a.name,a.id),children:a.markers.length>0&&a.markers.map(r=>e.jsx(X,{item:r,layerId:a.id,onEdit:()=>n(r,a.id)},r.id))},a.id)),!i.mid&&e.jsx("button",{className:"w-full mt-2 h-12",children:e.jsxs("div",{className:"w-[95%] h-full mx-auto flex justify-center items-center relative border-dashed border-2 text-gray-500","data-cy":"importMap",children:[e.jsx(J,{className:"absolute",type:"full",ref:g}),e.jsx(G,{size:24}),e.jsx("p",{className:"ml-2",children:d("mapUpload.importMap")})]})})]})}):e.jsx("div",{className:"p-4 pt-16",children:e.jsx(K,{})}),e.jsxs(h.Suspense,{fallback:e.jsx("div",{children:"Loading..."}),children:[o&&e.jsx(me,{marker:o.marker,layerId:o.layerId,open:o,onClose:()=>y(null),className:"cursor-pointer"}),m&&e.jsx(pe,{layerId:m.layerId,layerName:m.layerName,open:m,onClose:()=>t(null)})]})]})}export{Ie as default};
