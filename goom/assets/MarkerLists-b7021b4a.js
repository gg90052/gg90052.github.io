import{r as j,b as w,j as e,c as g,d as B,e as T,f as F,g as b,J as D}from"./index-f433997a.js";import{M as O,B as H,R as J}from"./ReadmeBtn-ca1c3df4.js";import{F as U,M as A}from"./MarkerItem-c1b8b39f.js";import{b as P,c as $,d as q,e as V}from"./index.esm-c108f41b.js";import{B as N}from"./button-c80087dc.js";import{D as C,a as M,b as S,c as E,d as I,e as z}from"./dialog-7aee5936.js";import{I as G}from"./input-938f7d21.js";import{u as L}from"./useLocalStorageState-317b2c03.js";import{b as R,c as K,e as Q}from"./utils-2d860b5a.js";import{u as v}from"./jszip.min-25157898.js";import{u as k}from"./useDispatch-b8c750aa.js";import{a as W}from"./index.esm-558cdf52.js";import{M as X}from"./index.esm-2c713c8b.js";import"./index.esm-a3c99c87.js";import"./index.esm-67d1cb07.js";import"./Icon-e13f9d7d.js";function Y({layerName:l,layerId:i,className:m}){const{t:r}=v(),[d,c]=j.useState(""),{defaultMap:h}=w(o=>o.maps),[p,y]=L("-1","defaultLayer"),[x,a]=L([],"showedLayer"),s=k(),t=R(h),n=()=>{const o=t.data.find(f=>f.id===i);o.name=d,s(g(t))},u=()=>{t.data=t.data.filter(o=>o.id!==i),s(g(t)),i===p&&y("-1"),x.includes(i)&&a(x.filter(o=>o!==i))};return e.jsxs(C,{children:[e.jsx(M,{children:e.jsx("div",{className:"w-6 h-6",children:e.jsx(U,{size:24,"data-cy":"triggerEditLayerModal",className:m})})}),e.jsxs(S,{className:"modalContent","data-cy":"editLayerModal",children:[e.jsx(E,{children:e.jsx(I,{children:r("common.edit")+r("common.layer")})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:r("common.layer")+r("common.name")}),e.jsx(G,{id:"layerName","data-cy":"layerNameInput",defaultValue:l,onChange:o=>c(o.target.value),className:"w-full"})]}),e.jsxs(z,{className:"w-full flex flex-row flex-nowrap items-center",children:[e.jsx(M,{asChild:!0,children:e.jsx(N,{className:"w-[90px] shrink-0 mr-8 text-red-700 hover:text-red-500",variant:"ghost","data-cy":"deleteLayer",size:"sm",onClick:u,children:r("common.delete")+r("common.layer")})}),e.jsx(M,{asChild:!0,children:e.jsx(N,{className:"grow shrink-0","data-cy":"saveLayer",type:"submit",onClick:n,children:r("common.save")})})]})]})]})}function Z({layerId:l,name:i,children:m}){var s;const{isEditMode:r,defaultMap:d}=w(t=>t.maps),[c,h]=L([],"showedLayer"),[p,y]=j.useState(c.includes(l)),x=((s=d.data.find(t=>t.id===l))==null?void 0:s.markers.length)||0,a=t=>{y(u=>!u);const n=JSON.parse(localStorage.getItem("showedLayer"));n.includes(l)?h(n.filter(u=>u!==l)):h([...n,l])};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"markerLayer","data-cy":"layer-comp",children:[p===!0?e.jsx(P,{size:24,fill:"#73D0FA"}):e.jsx($,{size:24,fill:"#73D0FA"}),e.jsx("p",{className:"grow",onClick:a,children:`${i} (${x})`}),e.jsx("div",{className:r?"w-6 h-6":"hidden",children:e.jsx(Y,{className:r?"slideIn":"slideOutRight",layerId:l,layerName:i})})]}),p===!0&&e.jsx("ul",{children:m})]})}function _({className:l}){const{t:i}=v(),{selectedMarkerItem:m,defaultMap:r,mymaps:d}=w(a=>a.maps),[c,h]=j.useState(r.data?r.data[0].id:"-1"),p=k(),y=()=>{const a=x();p(B([])),p(g(a))},x=()=>{let a=[];const s=r.data.map(n=>{const u=n.markers.filter(o=>{const f=m.includes(o.id);return f&&a.push(o),!f});return{...n,markers:u}}),t=s.findIndex(n=>n.id===c);if(t>-1){const n=s[t];s[t]={...n,markers:[...n.markers,...a]}}return{...r,data:s}};return e.jsxs(C,{children:[e.jsx(M,{children:e.jsx(X,{size:24,fill:"#F1D272",className:l})}),e.jsxs(S,{className:"modalContent","data-cy":"editLayerModal",children:[e.jsx(E,{children:e.jsxs(I,{children:[i("index.moveMarker"),"..."]})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:i("index.selectLayer")}),e.jsx("select",{className:"w-full h-10 border border-gray-300 rounded-md px-2",value:c,onChange:a=>h(a.target.value),children:r.data&&r.data.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))})]}),e.jsx(z,{className:"w-full flex flex-row flex-nowrap items-center",children:e.jsx(M,{asChild:!0,children:e.jsx(N,{className:"grow shrink-0","data-cy":"saveLayer",type:"submit",onClick:y,children:i("index.move")})})})]})]})}function ee({name:l,addLayer:i=!0,sync:m}){const{t:r}=v(),{defaultMap:d,isEditMode:c,selectedMarkerItem:h}=w(n=>n.maps),[p,y]=L("-1","defaultLayer"),{pathname:x}=T(),a=F(),s=k();j.useEffect(()=>{s(b(!1))},[x,s]);const t=()=>{if(!c)return;const n=R(d),u=K();n.data=[...n.data,u],s(g(n)),p==="-1"&&y(u.id)};return e.jsx("header",{className:"h-14 flex px-4 items-center gap-4 justify-between bg-slate-100 fixed top-0 left-0 w-full z-40",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-4 grow",children:[e.jsxs(N,{"data-cy":"map-name",variant:"outline",onClick:()=>a("/mapSelect"),children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),l]}),e.jsx(W,{className:c||d.mid?"hidden":"",size:24,color:"#5bb531",onClick:m,"data-cy":"syncMap"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(_,{className:c&&h.length>0?"fadeIn":"fadeOut hidden"}),e.jsx(V,{"data-cy":"add-layer",className:c?"fadeIn":"fadeOut",onClick:t,size:24,fill:"#F1D272"}),e.jsx("p",{"data-cy":"trigger-edit-mode",className:"text-blue-500 whitespace-nowrap",onClick:()=>s(b(!c)),children:r(c?"common.finish":"common.edit")})]})]}):e.jsx("p",{children:l})})}function ye(){var x;const{t:l}=v(),i=k(),{defaultMap:m}=w(a=>a.maps),r=j.useRef(),[d,c]=j.useState(m),h=F();j.useEffect(()=>{c(m)},[m]),j.useEffect(()=>{m.data||h("/mapSelect")},[m,h]);const p=async()=>{const a=d.data.filter(t=>t.mid),s=[...new Set(a.map(t=>t.mid))];try{const n=(await Promise.all(s.map(f=>y(f)))).flatMap(f=>f.data),u=[...d.data.filter(f=>!f.mid),...n],o={...d,data:u};c(o),i(g(o)),D.success("地圖同步完成")}catch(t){console.error(t),D.error("同步過程發生錯誤")}finally{}},y=async a=>{try{const s=await Q(a);return s.data.forEach(t=>{t.mid=a}),s}catch(s){console.log(s)}};return e.jsxs(e.Fragment,{children:[e.jsx(ee,{name:d.name,sync:p}),((x=d==null?void 0:d.data)==null?void 0:x.length)>0?e.jsx(e.Fragment,{children:e.jsxs("div",{style:{height:"100%",overflow:"auto",paddingTop:"3.5rem",paddingBottom:"4.5rem"},children:[d.data&&d.data.map(a=>e.jsx(Z,{name:a.name,layerId:a.id,mapId:d.id,mid:a.mid,syncLayer:p,children:a.markers.length>0&&a.markers.map(s=>e.jsx(A,{item:s,layerId:a.id},s.id))},a.id)),e.jsx("button",{className:"w-full mt-2 h-12",children:e.jsxs("div",{className:"w-[95%] h-full mx-auto flex justify-center items-center relative border-dashed border-2 text-gray-500","data-cy":"importMap",children:[e.jsx(O,{className:"absolute",importNewMap:!0,type:"full",ref:r}),e.jsx(H,{size:24}),e.jsx("p",{className:"ml-2",children:l("mapUpload.importMap")})]})})]})}):e.jsx("div",{className:"p-4 pt-16",children:e.jsx(J,{})})]})}export{ye as default};
