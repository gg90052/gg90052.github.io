import{b as v,r as h,j as e,d as T,c as L,e as O,f as B,g as E,_ as S,N as P,J as F}from"./index-d4c0aa35.js";import{D as A,a as b,b as H,c as J,d as U,e as V,M as $,B as q,R as G}from"./ReadmeBtn-35e8ef26.js";import{F as K,M as Q}from"./MarkerItem-5beb2b11.js";import{b as W,c as X,d as Y,e as Z}from"./index.esm-97e93b67.js";import{u as C}from"./useLocalStorageState-931ab4b8.js";import{B as _}from"./button-044e4012.js";import{b as ee,c as ae,e as se}from"./utils-3d32e68b.js";import{a as te}from"./index.esm-1f0a606d.js";import{M as re}from"./index.esm-0c89c783.js";import{u as N}from"./iconBase-fa96f2cb.js";import{u as D}from"./useDispatch-5d8e2ac9.js";import"./index.esm-c505d778.js";import"./index.esm-bd54f932.js";import"./Icon-d51ae2f7.js";function ne({layerId:d,name:x,children:f,onEdit:m}){var n;const{isEditMode:j,mymaps:o,showMapID:s}=v(c=>c.maps),g=o.find(c=>c.id===s),[l,y]=C([],"showedLayer"),[p,t]=h.useState(l.includes(d)),u=((n=g.data.find(c=>c.id===d))==null?void 0:n.markers.length)||0,M=c=>{t(a=>!a);const r=JSON.parse(localStorage.getItem("showedLayer"));r.includes(d)?y(r.filter(a=>a!==d)):y([...r,d])};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"markerLayer","data-cy":"layer-comp",children:[p===!0?e.jsx(W,{size:24,fill:"#73D0FA"}):e.jsx(X,{size:24,fill:"#73D0FA"}),e.jsx("p",{className:"grow",onClick:M,children:`${x} (${u})`}),e.jsx("div",{className:j?"w-6 h-6":"hidden",children:e.jsx("div",{className:"w-6 h-6",children:e.jsx(K,{size:24,"data-cy":"triggerEditLayerModal",className:j?"slideIn":"slideOutRight",onClick:m})})})]}),p===!0&&e.jsx("ul",{children:f})]})}function ie({className:d}){const{t:x}=N(),{selectedMarkerItem:f,mymaps:m,showMapID:j}=v(t=>t.maps),o=m.find(t=>t.id===j),[s,g]=h.useState(o.data?o.data[0].id:"-1"),l=D(),y=()=>{const t=p();l(T([])),l(L(t))},p=()=>{let t=[];const u=o.data.map(n=>{const c=n.markers.filter(r=>{const a=f.includes(r.id);return a&&t.push(r),!a});return{...n,markers:c}}),M=u.findIndex(n=>n.id===s);if(M>-1){const n=u[M];u[M]={...n,markers:[...n.markers,...t]}}return{...o,data:u}};return e.jsxs(A,{children:[e.jsx(b,{children:e.jsx(re,{size:24,fill:"#F1D272",className:d})}),e.jsxs(H,{className:"modalContent","data-cy":"editLayerModal",children:[e.jsx(J,{children:e.jsxs(U,{children:[x("index.moveMarker"),"..."]})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-slate-500 -mb-3",children:x("index.selectLayer")}),e.jsx("select",{className:"w-full h-10 border border-gray-300 rounded-md px-2",value:s,onChange:t=>g(t.target.value),children:o.data&&o.data.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsx(V,{className:"w-full flex flex-row flex-nowrap items-center",children:e.jsx(b,{asChild:!0,children:e.jsx(_,{className:"grow shrink-0","data-cy":"saveLayer",type:"submit",onClick:y,children:x("index.move")})})})]})]})}function de({name:d,addLayer:x=!0,sync:f}){const{t:m}=N(),{mymaps:j,showMapID:o,isEditMode:s,selectedMarkerItem:g}=v(r=>r.maps),l=j.find(r=>r.id===o),y=l.data.some(r=>r.mid),[p,t]=C("-1","defaultLayer"),{pathname:u}=O(),M=B(),n=D();h.useEffect(()=>{n(E(!1))},[u,n]);const c=()=>{if(!s)return;const r=ee(l),a=ae();r.data=[...r.data,a],n(L(r)),p==="-1"&&t(a.id)};return e.jsx("header",{className:"h-14 flex px-4 items-center gap-4 justify-between bg-slate-100 fixed top-0 left-0 w-full z-40",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-4 grow",children:[e.jsxs(_,{"data-cy":"map-name",variant:"outline",onClick:()=>M("/mapSelect"),children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),d]}),y&&e.jsx(te,{className:s?"hidden":"",size:24,color:"#5bb531",onClick:f,"data-cy":"syncMap"})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(ie,{className:s&&g.length>0?"fadeIn":"fadeOut hidden"}),e.jsx(Z,{"data-cy":"add-layer",className:s?"fadeIn":"fadeOut",onClick:c,size:24,fill:"#F1D272"}),e.jsx("p",{"data-cy":"trigger-edit-mode",className:"text-blue-500 whitespace-nowrap",onClick:()=>n(E(!s)),children:m(s?"common.finish":"common.edit")})]})]}):e.jsx("p",{children:d})})}const oe=h.lazy(()=>S(()=>import("./EditMarkerModal-5d23e6c6.js"),["assets/EditMarkerModal-5d23e6c6.js","assets/index-d4c0aa35.js","assets/index-496e6255.css","assets/button-044e4012.js","assets/ReadmeBtn-35e8ef26.js","assets/iconBase-fa96f2cb.js","assets/utils-3d32e68b.js","assets/useDispatch-5d8e2ac9.js","assets/index.esm-c505d778.js"])),le=h.lazy(()=>S(()=>import("./EditLayerModal-0f90089e.js"),["assets/EditLayerModal-0f90089e.js","assets/index-d4c0aa35.js","assets/index-496e6255.css","assets/button-044e4012.js","assets/ReadmeBtn-35e8ef26.js","assets/iconBase-fa96f2cb.js","assets/utils-3d32e68b.js","assets/useDispatch-5d8e2ac9.js","assets/index.esm-c505d778.js","assets/MarkerItem-5beb2b11.js","assets/index.esm-1f0a606d.js","assets/index.esm-bd54f932.js","assets/index.esm-0c89c783.js","assets/Icon-d51ae2f7.js","assets/useLocalStorageState-931ab4b8.js"]));function Le(){var r;const{t:d}=N(),x=D(),{mymaps:f,showMapID:m}=v(a=>a.maps),j=h.useRef(),o=f.find(a=>a.id===m),[s,g]=h.useState(o),[l,y]=h.useState(null),[p,t]=h.useState(null);if(h.useEffect(()=>{g(f.find(a=>a.id===m))},[m,f]),m==="")return e.jsx(P,{to:"/mapSelect"});const u=async()=>{const a=s.data.filter(w=>w.mid),i=[...new Set(a.map(w=>w.mid))];try{const z=(await Promise.all(i.map(k=>M(k)))).flatMap(k=>k.data),R=[...s.data.filter(k=>!k.mid),...z],I={...s,data:R};g(I),x(L(I)),F.success("地圖同步完成")}catch(w){console.error(w),F.error("同步過程發生錯誤")}finally{}},M=async a=>{try{const i=await se(a);return i.data.forEach(w=>{w.mid=a}),i}catch(i){console.log(i)}},n=(a,i)=>{y({marker:a,layerId:i})},c=(a,i)=>{t({layerId:i,layerName:a})};return e.jsxs(e.Fragment,{children:[e.jsx(de,{name:s.name,sync:u}),((r=s==null?void 0:s.data)==null?void 0:r.length)>0?e.jsx(e.Fragment,{children:e.jsxs("div",{style:{height:"100%",overflow:"auto",paddingTop:"3.5rem",paddingBottom:"4.5rem"},children:[s.data&&s.data.map(a=>e.jsx(ne,{name:a.name,layerId:a.id,mapId:s.id,mid:a.mid,syncLayer:u,onEdit:()=>c(a.name,a.id),children:a.markers.length>0&&a.markers.map(i=>e.jsx(Q,{item:i,layerId:a.id,onEdit:()=>n(i,a.id)},i.id))},a.id)),e.jsx("button",{className:"w-full mt-2 h-12",children:e.jsxs("div",{className:"w-[95%] h-full mx-auto flex justify-center items-center relative border-dashed border-2 text-gray-500","data-cy":"importMap",children:[e.jsx($,{className:"absolute",type:"full",ref:j}),e.jsx(q,{size:24}),e.jsx("p",{className:"ml-2",children:d("mapUpload.importMap")})]})})]})}):e.jsx("div",{className:"p-4 pt-16",children:e.jsx(G,{})}),e.jsxs(h.Suspense,{fallback:e.jsx("div",{children:"Loading..."}),children:[l&&e.jsx(oe,{marker:l.marker,layerId:l.layerId,open:l,onClose:()=>y(null),className:"cursor-pointer"}),p&&e.jsx(le,{layerId:p.layerId,layerName:p.layerName,open:p,onClose:()=>t(null)})]})]})}export{Le as default};
