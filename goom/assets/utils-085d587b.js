import{J as b}from"./jszip.min-4f72041e.js";import{q as g}from"./index-b52732e4.js";function S(){return Math.random().toString(36).slice(2,9)}function v(e){var o=new DOMParser,r=o.parseFromString(e,"text/xml");let n=[];function s(t){t.querySelectorAll("Placemark").forEach(function(c){const a={id:"",point:[],name:"",description:"",icon:""};a.id=S();const h=c.querySelector("coordinates");if(h){const m=h.textContent.trim().split(",");a.point=[parseFloat(m[0]),parseFloat(m[1])]}const f=c.querySelector("styleUrl");f&&(a.icon=f.textContent.trim().replace("#",""));const y=c.querySelector("name");y&&(a.name=y.textContent.trim());const w=c.querySelector("description");w&&(a.description=w.textContent.trim());const k=t.querySelector("name").textContent.trim(),q=n.find(m=>m.name===k);if(q)q.markers.push(a);else{const m=S();n.push({id:m,name:k,markers:[a]})}});var u=t.querySelectorAll("Folder");u.forEach(function(c){s(c)})}var d=r.querySelectorAll("Style"),p={};d.forEach(function(t){const l=t.getAttribute("id").slice(0,t.getAttribute("id").lastIndexOf("-"));let u="";var c=t.querySelector("IconStyle");if(c){var a=c.querySelector("Icon");a&&(u=a.querySelector("href").textContent)}p[l]=u});var i=r.querySelectorAll("Folder");return i.length===0?s(r):i.forEach(function(t){s(t)}),{kmlJson:n,styleInKMZ:p,isMap:i.length>0}}function M(e){return new Promise((o,r)=>{const n=[];var s=new FileReader;s.onload=function(d){var p=new b;p.loadAsync(d.target.result).then(function(i){i.forEach(function(t,l){if(l.name.endsWith(".kml")){const u=l.async("string").then(function(c){return new Promise((a,h)=>{a(v(c))})});n.push(u)}if(t.startsWith("images/")){const u=l.async("blob").then(function(c){return new Promise((a,h)=>{var f=new FileReader;f.readAsDataURL(c),f.onloadend=function(){var y=f.result;a({name:t,url:y})}})});n.push(u)}}),Promise.all(n).then(t=>{o(t)})})},s.readAsArrayBuffer(e)})}async function x(e,o,r=!1){const n=await fetch("https://www.google.com/maps/d/kml?forcekml=0&mid="+e).then(t=>{if(t.ok)return t.blob();throw new Error(g.t("mapUpload.midError"))}).then(t=>t).catch(t=>{alert(g.t("mapUpload.mapError")),console.log(t)}),[{kmlJson:s,styleInKMZ:d,isMap:p},...i]=await M(n);if(A(d,i),p){if(r===!1)return{id:Date.now(),name:o||`${new Date().toLocaleDateString()} ${g.t("mapUpload.importedMap")}`,data:s,mid:e};{const t=JSON.parse(localStorage.getItem("mymaps"))||[];return t.forEach(l=>{l.id===r&&(l.data=s)}),localStorage.setItem("mymaps",JSON.stringify(t)),t.find(l=>l.id===r)}}}function A(e,o){const r=JSON.parse(localStorage.getItem("icons"))||{},n={};Object.entries(e).forEach(([s,d])=>{var i;const p=P(s);n[p]||(n[p]=(i=o.find(t=>t.name===d))==null?void 0:i.url)}),localStorage.setItem("icons",JSON.stringify({...r,...n}))}function P(e){const o=e.split("-");return`${o[0]}-${o[1]}-${o[2]}`}function U(e){return JSON.parse(JSON.stringify(e))}function $(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function I(e){return{google:$()?"comgooglemapsurl://":"https://www.google.com/maps/search/?api=1",apple:$()?"maps://":"applemaps://",naver:"nmap://"}[e]}function N(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",r=I(o);let n;switch(o){case"google":n=$()?`?q=${e.name}&center=${e.point[1]},${e.point[0]}`:`&query=${e.point[1]},${e.point[0]}`,e.place_id&&(n+=`&query_place_id=${e.place_id}`);break;case"apple":n=`maps.apple.com/?sll=${e.point[1]},${e.point[0]}&q=${e.name}`;break;case"naver":n=`search?query=${e.name}`;break;default:n=`@${e.point[1]},${e.point[0]}+(${e.name})`;break}return`${r}${n}`}function C(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",r=I(o);let n;switch(o){case"google":n=$()?`?q=@${e.point[1]},${e.point[0]}+(${e.name})`:`&query=${e.point[1]},${e.point[0]}`,e.place_id&&(n+=`&query_place_id=${e.place_id}`);break;case"apple":n=`maps.apple.com/?ll=${e.point[1]},${e.point[0]}&q=${e.name}`;break;case"naver":n=`place?lat=${e.point[1]}&lng=${e.point[0]}&name=${e.name}`;break;default:n=`@${e.point[1]},${e.point[0]}+(${e.name})`;break}return`${r}${n}`}function E(e){return{description:"",icon:"",name:e.name,place_id:e.place_id,id:S(),point:[e.geometry.lng,e.geometry.lat]}}function F(){return{id:S(),name:g.t("mapUpload.newLayer"),markers:[]}}function D(e){return{id:Date.now(),name:e||g.t("mapUpload.newMap"),data:[F()]}}function J(e){const n=new DOMParser().parseFromString(e,"text/html").body.textContent||"",s=/https?:\/\/\S+/g;return n.match(s)||[]}function L(e){return e&&`<a href="${e}" style="color:#1a73e8" target="_blank" rel="noreferrer">${e}</a>`}function j(e){const o=J(e);let r=e;return o.forEach(n=>{r=r.replace(n,L(n))}),r}export{E as a,U as b,F as c,C as d,x as e,j as f,N as g,$ as h,D as i,P as s};
