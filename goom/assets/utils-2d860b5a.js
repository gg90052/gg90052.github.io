import{J as I}from"./jszip.min-25157898.js";import{q as g}from"./index-f433997a.js";function y(){return Math.random().toString(36).slice(2,9)}function v(e){var o=new DOMParser,a=o.parseFromString(e,"text/xml");let n=[];function r(t){t.querySelectorAll("Placemark").forEach(function(i){const s={id:"",point:[],name:"",description:"",icon:""};s.id=y();const h=i.querySelector("coordinates");if(h){const m=h.textContent.trim().split(",");s.point=[parseFloat(m[0]),parseFloat(m[1])]}const f=i.querySelector("styleUrl");f&&(s.icon=f.textContent.trim().replace("#",""));const S=i.querySelector("name");S&&(s.name=S.textContent.trim());const w=i.querySelector("description");w&&(s.description=w.textContent.trim());const k=t.querySelector("name").textContent.trim(),b=n.find(m=>m.name===k);if(b)b.markers.push(s);else{const m=y();n.push({id:m,name:k,markers:[s]})}});var u=t.querySelectorAll("Folder");u.forEach(function(i){r(i)})}var l=a.querySelectorAll("Style"),c={};l.forEach(function(t){const p=t.getAttribute("id").slice(0,t.getAttribute("id").lastIndexOf("-"));let u="";var i=t.querySelector("IconStyle");if(i){var s=i.querySelector("Icon");s&&(u=s.querySelector("href").textContent)}c[p]=u});var d=a.querySelectorAll("Folder");return d.length===0?r(a):d.forEach(function(t){r(t)}),{kmlJson:n,styleInKMZ:c,isMap:d.length>0}}function M(e){return new Promise((o,a)=>{const n=[];var r=new FileReader;r.onload=function(l){var c=new I;c.loadAsync(l.target.result).then(function(d){d.forEach(function(t,p){if(p.name.endsWith(".kml")){const u=p.async("string").then(function(i){return new Promise((s,h)=>{s(v(i))})});n.push(u)}if(t.startsWith("images/")){const u=p.async("blob").then(function(i){return new Promise((s,h)=>{var f=new FileReader;f.readAsDataURL(i),f.onloadend=function(){var S=f.result;s({name:t,url:S})}})});n.push(u)}}),Promise.all(n).then(t=>{o(t)})})},r.readAsArrayBuffer(e)})}async function U(e,o,a=!1){const n=await fetch("https://www.google.com/maps/d/kml?forcekml=0&mid="+e).then(t=>{if(t.ok)return t.blob();throw new Error(g.t("mapUpload.midError"))}).then(t=>t).catch(t=>{alert(g.t("mapUpload.mapError")),console.log(t)}),[{kmlJson:r,styleInKMZ:l,isMap:c},...d]=await M(n);if(A(l,d),c){if(a===!1)return{id:Date.now(),name:o||`${new Date().toLocaleDateString()} ${g.t("mapUpload.importedMap")}`,data:r,mid:e};{const t=JSON.parse(localStorage.getItem("mymaps"))||[];return t.forEach(p=>{p.id===a&&(p.data=r)}),localStorage.setItem("mymaps",JSON.stringify(t)),t.find(p=>p.id===a)}}}function A(e,o){const a=JSON.parse(localStorage.getItem("icons"))||{},n={};Object.entries(e).forEach(([r,l])=>{var d;const c=P(r);n[c]||(n[c]=(d=o.find(t=>t.name===l))==null?void 0:d.url)}),localStorage.setItem("icons",JSON.stringify({...a,...n}))}function P(e){const o=e.split("-");return`${o[0]}-${o[1]}-${o[2]}`}function _(e){return JSON.parse(JSON.stringify(e))}function $(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function q(e){return{google:$()?"comgooglemapsurl://":"https://www.google.com/maps/search/?api=1",apple:$()?"maps://":"applemaps://",naver:"nmap://"}[e]}function N(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",a=q(o);let n=e.name;if(e.description&&e.description.includes("Title: ")){const l=e.description.indexOf("Title: ")+7,c=e.description.indexOf("<br>",l);c!==-1&&(n=e.description.substring(l,c===-1?e.description.length:c).trim())}let r;switch(o){case"google":r=$()?`?q=${n}&center=${e.point[1]},${e.point[0]}`:`&query=${n}&center=${e.point[1]},${e.point[0]}`,e.place_id&&(r+=`&query_place_id=${e.place_id}`);break;case"apple":r=`maps.apple.com/?sll=${e.point[1]},${e.point[0]}&q=${n}`;break;case"naver":r=`search?query=${n}`;break;default:r=`@${e.point[1]},${e.point[0]}+(${n})`;break}return encodeURI(`${a}${r}`)}function E(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",a=q(o);let n;switch(o){case"google":n=$()?`?q=@${e.point[1]},${e.point[0]}+(${e.name})`:`&query=${e.point[1]},${e.point[0]}`,e.place_id&&(n+=`&query_place_id=${e.place_id}`);break;case"apple":n=`maps.apple.com/?ll=${e.point[1]},${e.point[0]}&q=${e.name}`;break;case"naver":n=`place?lat=${e.point[1]}&lng=${e.point[0]}&name=${e.name}`;break;default:n=`@${e.point[1]},${e.point[0]}+(${e.name})`;break}return`${a}${n}`}function C(e){return{description:"",icon:"",name:e.name,place_id:e.place_id,id:y(),point:[e.geometry.lng,e.geometry.lat]}}function F(){return{id:y(),name:g.t("mapUpload.newLayer"),markers:[]}}function D(e){return{id:Date.now(),name:e||g.t("mapUpload.newMap"),data:[F()]}}function O(e){const n=new DOMParser().parseFromString(e,"text/html").body.textContent||"",r=/https?:\/\/\S+/g;return n.match(r)||[]}function J(e){return e&&`<a href="${e}" style="color:#1a73e8" target="_blank" rel="noreferrer">${e}</a>`}function T(e){const o=O(e);let a=e;return o.forEach(n=>{a=a.replace(n,J(n))}),a}export{C as a,_ as b,F as c,E as d,U as e,T as f,N as g,$ as h,D as i,P as s};
