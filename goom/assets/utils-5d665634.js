import{J as I}from"./jszip.min-c6f4c7f2.js";function S(){return Math.random().toString(36).slice(2,9)}function b(e){var o=new DOMParser,r=o.parseFromString(e,"text/xml");let n=[];function s(t){t.querySelectorAll("Placemark").forEach(function(c){const a={id:"",point:[],name:"",description:"",icon:""};a.id=S();const g=c.querySelector("coordinates");if(g){const m=g.textContent.trim().split(",");a.point=[parseFloat(m[0]),parseFloat(m[1])]}const f=c.querySelector("styleUrl");f&&(a.icon=f.textContent.trim().replace("#",""));const h=c.querySelector("name");h&&(a.name=h.textContent.trim());const $=c.querySelector("description");$&&(a.description=$.textContent.trim());const w=t.querySelector("name").textContent.trim(),k=n.find(m=>m.name===w);if(k)k.markers.push(a);else{const m=S();n.push({id:m,name:w,markers:[a]})}});var d=t.querySelectorAll("Folder");d.forEach(function(c){s(c)})}var u=r.querySelectorAll("Style"),p={};u.forEach(function(t){const l=t.getAttribute("id").slice(0,t.getAttribute("id").lastIndexOf("-"));let d="";var c=t.querySelector("IconStyle");if(c){var a=c.querySelector("Icon");a&&(d=a.querySelector("href").textContent)}p[l]=d});var i=r.querySelectorAll("Folder");return i.length===0?s(r):i.forEach(function(t){s(t)}),{kmlJson:n,styleInKMZ:p,isMap:i.length>0}}function v(e){return new Promise((o,r)=>{const n=[];var s=new FileReader;s.onload=function(u){var p=new I;p.loadAsync(u.target.result).then(function(i){i.forEach(function(t,l){if(l.name.endsWith(".kml")){const d=l.async("string").then(function(c){return new Promise((a,g)=>{a(b(c))})});n.push(d)}if(t.startsWith("images/")){const d=l.async("blob").then(function(c){return new Promise((a,g)=>{var f=new FileReader;f.readAsDataURL(c),f.onloadend=function(){var h=f.result;a({name:t,url:h})}})});n.push(d)}}),Promise.all(n).then(t=>{o(t)})})},s.readAsArrayBuffer(e)})}async function L(e,o,r=!1){const n=await fetch("https://www.google.com/maps/d/kml?forcekml=0&mid="+e).then(t=>{if(t.ok)return t.blob();throw new Error("找不到地圖，請再次確認mid是否正確")}).then(t=>t).catch(t=>{alert(t)}),[{kmlJson:s,styleInKMZ:u,isMap:p},...i]=await v(n);if(A(u,i),p){if(r===!1)return{id:Date.now(),name:o||`${new Date().toLocaleDateString()} 匯入的地圖`,data:s,mid:e};{const t=JSON.parse(localStorage.getItem("mymaps"))||[];return t.forEach(l=>{l.id===r&&(l.data=s)}),localStorage.setItem("mymaps",JSON.stringify(t)),t.find(l=>l.id===r)}}}function A(e,o){const r=JSON.parse(localStorage.getItem("icons"))||{},n={};Object.entries(e).forEach(([s,u])=>{var i;const p=M(s);n[p]||(n[p]=(i=o.find(t=>t.name===u))==null?void 0:i.url)}),localStorage.setItem("icons",JSON.stringify({...r,...n}))}function M(e){const o=e.split("-");return`${o[0]}-${o[1]}-${o[2]}`}function _(e){return JSON.parse(JSON.stringify(e))}function y(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function q(e){return{google:y()?"comgooglemapsurl://":"https://www.google.com/maps/search/?api=1",apple:y()?"maps://":"applemaps://",naver:"nmap://"}[e]}function x(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",r=q(o);let n;switch(o){case"google":n=y()?`?q=${e.name}&center=${e.point[1]},${e.point[0]}`:`&query=${e.point[1]},${e.point[0]}`,e.place_id&&(n+=`&query_place_id=${e.place_id}`);break;case"apple":n=`maps.apple.com/?sll=${e.point[1]},${e.point[0]}&q=${e.name}`;break;case"naver":n=`search?query=${e.name}`;break;default:n=`@${e.point[1]},${e.point[0]}+(${e.name})`;break}return`${r}${n}`}function N(e){const o=localStorage.getItem("defaultApp")?JSON.parse(localStorage.getItem("defaultApp")):"google",r=q(o);let n;switch(o){case"google":n=y()?`?q=@${e.point[1]},${e.point[0]}+(${e.name})`:`&query=${e.point[1]},${e.point[0]}`,e.place_id&&(n+=`&query_place_id=${e.place_id}`);break;case"apple":n=`maps.apple.com/?ll=${e.point[1]},${e.point[0]}&q=${e.name}`;break;case"naver":n=`place?lat=${e.point[1]}&lng=${e.point[0]}&name=${e.name}`;break;default:n=`@${e.point[1]},${e.point[0]}+(${e.name})`;break}return`${r}${n}`}function C(e){return{description:"",icon:"",name:e.name,place_id:e.place_id,id:S(),point:[e.geometry.lng,e.geometry.lat]}}function P(){return{id:S(),name:"新圖層",markers:[]}}function D(e=!1){return{id:Date.now(),name:"新地圖",data:e?[P()]:[]}}function F(e){const n=new DOMParser().parseFromString(e,"text/html").body.textContent||"",s=/https?:\/\/\S+/g;return n.match(s)||[]}function J(e){return e&&`<a href="${e}" style="color:#1a73e8" target="_blank" rel="noreferrer">${e}</a>`}function E(e){const o=F(e);let r=e;return o.forEach(n=>{r=r.replace(n,J(n))}),r}export{C as a,_ as b,P as c,x as d,L as e,E as f,N as g,y as h,D as i,M as s};
